<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="HandheldFriendly" content="true" />
		<meta name="MobileOptimized" content="320" />
		<title></title>
		<link href="css/mui.min.css" rel="stylesheet" />
		<link href="css/style.css" rel="stylesheet" />

		<link rel="stylesheet" href="css/common.css">
		<link rel="stylesheet" href="css/iconfont.css">
		<script src="js/mui.min.js"></script>
		<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=ylg8yBCSUPFnuu82sDnIbZ5H"></script>
		<!--<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=726ZqpsoTe2765d1KaY5kqkd"></script>-->
		<script type="text/javascript" src="js/request_url.js"></script>
		<style>
			html,
			body {
				width: 100%;
				height: 100%;
			}
			
			.mui-bar-tab .mui-tab-item {
				color: #555555;
				vertical-align: bottom;
				padding-bottom: 10px;
			}
			
			.mui-bar-tab .mui-tab-item.mui-active {
				color: #555555;
			}
			
			#map {				 
				text-align: center;
				position: absolute;
				top: 0px;
				bottom: 55px;
				width: 100%;				
			}
			
			.mui-bar-tab .mui-tab-item .mui-icon ~ .mui-tab-label {
				font-size: 15px;
			}
			
			#map_result_div {
				position: absolute;
				width: 100%;
				text-align: center;
				top: 35%;
				vertical-align: middle;
			}
			
			#map_result {
				width: auto;
				display: inline-block;
				height: 11%;
				max-width: 80%;
				line-height: 25px;
				text-align: center;
				margin: 0 auto;
				top: 35%;
				left: 10%;
				border: 1px solid #ccc;
				padding: 5px;
				background: #FFFFFF;
				vertical-align: middle;
				border-radius: 5px;
				color: #666;
				font-size: 12px;
			}
			
			#map_result_img {
				width: 80%;
				height: 8%;
				text-align: center;
				top: 45%;
				left: 10%;
				padding: 8px;
				vertical-align: middle;
				border-radius: 5px;
				color: #666;
				font-size: 12px;
			}
			
		</style>
	</head>

	<body>
		
		<header class="mui-bar mui-bar-nav">
			<a id="person_center" class="mui-icon mui-pull-left">
				<img src="img/index_left_fresh_manual.png" width="25px" />
			</a>
			<a id="pop_adv" class="mui-icon mui-pull-right">
				<img src="img/icon_lw_blue.png" width="25px" />
			</a>
			<h1 class="mui-title">
			   <span>起点专车</span>	
			</h1>
		</header>

		<div class="mui-content">
			<nav class="mui-bar-tab bar_transparent">
				<a class="mui-tab-item" id="date_car">
					<span class="mui-icon iconfont  icon-yuyue"></span>
					<span class="mui-tab-label">预约用车</span>
				</a>
				<a class="mui-tab-item" id="fastdate_car">
					<span class="mui-icon iconfont icon-lijichuzu"></span>
					<span class="mui-tab-label">立即叫车</span>
				</a>
			</nav>
			<div id="map">地图加载中...</div>
			<div align="center" id="map_result_div">
				<div id="map_result">正在获取地址...</div>
			</div>

		</div>
		<div id="map_result_img" style="position: absolute;bottom: 50px;">
			<img src="img/markers.png" style="width: 20px;height: 30px;" />
		</div>
		<div id="back_current_position" style="position: absolute;bottom: 50px;">
			<img src="img/iconfont-wujiaoxing.png" width="50px" />
		</div>

		<!-- 弹出框广告信息-->
		<div id="pop_div" class="bar_transparent" style="width: 100%;height: 100%;display:none;">
			<div id="slider" class="mui-slider mui-fullscreen">
				<div class="mui-slider-group mui-slider-loop" id="banner">
					<!-- 额外增加的一个节点(循环轮播：第一个节点是最后一张轮播) -->
					 

				</div>
			</div>

	</body>

	<script>
		var islogin = 0;
		mui.init();
		document.getElementById("person_center").addEventListener('tap', function(e) {
			islogin = plus.storage.getItem('islogin');
			/*判空操作*/
			if (islogin == null) {
				plus.storage.setItem('islogin', 0);
			}
			console.log("islogin0====" + islogin);
			if ((islogin != 1) || (islogin != "1")) {
				mui.openWindow({
					id: "login",
					url: "login/login.html"
				});
			} else {
				mui.openWindow({
					id: "setting_menu",
					url: "setting_menu.html"
				});
			}
		});
		/*预约用车按钮事件*/
		var date_car = document.getElementById("date_car");
		date_car.addEventListener("tap", function() {
			islogin = plus.storage.getItem('islogin');
			/*判空操作*/
			if (islogin == null) {
				plus.storage.setItem('islogin', 0);
			}
			if ((islogin != 1) || (islogin != "1")) {
				mui.openWindow({
					id: "login",
					url: "login/login.html"
				});
			} else {
				plus.storage.setItem('date_type', "1");
				mui.openWindow({
					id: "yuyue",
					url: "yuyue.html"
				})
			}
		});
		/*预约用车按钮事件*/
		var fastdate_car = document.getElementById("fastdate_car");
		fastdate_car.addEventListener("tap", function() {			
			islogin = plus.storage.getItem('islogin');
			/*判空操作*/
			if (islogin == null) {
				plus.storage.setItem('islogin', 0);
			}
			if ((islogin != 1) || (islogin != "1")) {
				mui.openWindow({
					id: "login",
					url: "login/login.html"
				});
			} else {				
				var url = request_url + "get_user_order_state";
				mui.ajax(url, {
					data: {
						"user_pk": plus.storage.getItem('user_pk')
					},
					dataType: 'json', //服务器返回json格式数据
					type: 'post', //HTTP请求类型
					timeout: 5000, //超时时间设置为5秒；
					success: function(rsp) {						
						if(parseInt(rsp.result)==0) 
						{
							plus.storage.setItem('date_type', "2");
							mui.openWindow({
								id: "fast_yuyue",
								url: "fast_yuyue.html"
							});
						}
						else
						{
							mui.toast("您有未完成订单，暂不能叫车!");
						}
					}
				});							
			}
		});
	</script>

	<script type="text/javascript">
		//定义保存在用户端显示司机位置信息的数组
		var coach_lonArr = "";
		var coach_latArr = "";
		var preMarker = new Array();
		// var g_getinfo    = "";		
		mui.plusReady(function() {		
				mui.ajax(request_url + "get_ad", {	
					data: {
						"_type":"0000500001",							
					},
					dataType: 'json', //服务器返回json格式数据
					type: 'post', //HTTP请求类型
					timeout: 5000, //超时时间设置为5秒； 
					success: function(rsp) {
						console.log(rsp.Table[0].info_content);
						var str_ad="<div class=\"mui-slider-item mui-slider-item-duplicate\"><a href=\"#\"><img src=\""+ request_img_url + rsp.Table[rsp.Table.length-1].info_content +"\"></a></div>";
						for (var i = 0; i < rsp.Table.length; i++) { //0 立即叫车 1 预约 2半日租 3日租								
							var ad_img = request_img_url + rsp.Table[i].info_content;
							str_ad=str_ad+"<div class=\"mui-slider-item\"><a href=\"#\"><img src=\""+ ad_img +"\"></a></div>";
							
						} 
						str_ad=str_ad+"<div class=\"mui-slider-item mui-slider-item-duplicate\"><a href=\"#\"><img src=\""+ request_img_url + rsp.Table[0].info_content +"\"></a></div>";
						str_ad=str_ad+"<div></div>";
						str_ad=str_ad+"<div class=\"mui-slider-indicator\"><div class=\"mui-indicator mui-active\"></div><div class=\"mui-indicator\"></div></div>";
						document.getElementById("banner").innerHTML=str_ad;					
					}
				});		
				/*调用初始化定位信息*/
				var point2 = new BMap.Point(108.93, 34.27); // 创建点坐标
				map = new BMap.Map("map"); // 创建地图实例
				map.centerAndZoom(point2, 15); // 初始化地图，设置中心点坐标和地图级别
				map.addControl(new BMap.NavigationControl());
				/*定时获取司机集合 com=get_coach_list*/
				get_coachlist_info();
				document.getElementById("map_result").addEventListener("click", function() {
					islogin = plus.storage.getItem('islogin');
					/*判空操作*/
					if (islogin == null) {
						plus.storage.setItem('islogin', 0);
					}
					if ((islogin != 1) || (islogin != "1")) {
						mui.openWindow({
							id: "login",
							url: "login/login.html"
						});
					} else {
						var url = request_url + "get_user_order_state";
						mui.ajax(url, {
							data: {
								"user_pk": plus.storage.getItem('user_pk')
							},
							dataType: 'json', //服务器返回json格式数据
							type: 'post', //HTTP请求类型
							timeout: 5000, //超时时间设置为5秒；
							success: function(rsp) {
								console.log(rsp.result);
								if(parseInt(rsp.result)==0) 
								{
									plus.storage.setItem('date_type', "2");
									mui.openWindow({
										id: "fast_yuyue",
										url: "fast_yuyue.html"
									});
								}
								else
								{
									mui.toast("您有未完成订单，暂不能叫车!");
								}
							}
						});									
					}
				});
				function getPosition() {
					var mPoint = map.getCenter();
					var lat = mPoint.lat; //获取到当前位置的纬度；			
					var longt = mPoint.lng; //获取到当前位置的经度
					var url = "http://api.map.baidu.com/geocoder/v2/?ak=FC9c13967bf240823ed03d702d883e83&location=" + lat + "," + longt + "&output=json&pois=1"
					mui.getJSON(url, function(rsp) {
						if (rsp != null) {
							console.log(JSON.stringify(rsp));
							var addComp = rsp.result.addressComponent;
							var currentStreet = addComp.district + addComp.street;
							var currentPosition = rsp.result.sematic_description;
							console.log(currentPosition);
							if (currentPosition != "") {
								document.getElementById("map_result").innerHTML = "<lable style='color: darkgreen;font-weight: 900;'>我从</lable> " + currentStreet + "<br/>" + currentPosition + " <lable style='color: darkgreen;font-weight: 900;'>上车</lable>";
								plus.storage.setItem("start_postion", currentStreet + currentPosition + "&" + mPoint.lat + "&" + mPoint.lng);
							} else {
								document.getElementById("map_result").innerHTML = "<lable style='color: darkgreen;font-weight: 900;'>我从</lable> " + currentStreet + " <lable style='color: darkgreen;font-weight: 900;'>上车</lable>";
								plus.storage.setItem("start_postion", currentStreet + "&" + mPoint.lat + "&" + mPoint.lng);
							}
							
						}
					});
				}
				getPosBaidu();
				//开始移动地图
				map.addEventListener("dragstart", function(e) {
					var center = map.getCenter();
					//					addMarker(center);
					//					preMarker.setPosition(map.getCenter());
					document.getElementById("map_result_div").style.display = "none";
				});
				//移动地图结束
				map.addEventListener("dragend", function(e) {
					getPosition();
					document.getElementById("map_result_div").style.display = "";
				});
				/*点击显示隐藏广告框信息*/
				var pop_adv = document.getElementById("pop_adv");
				var pop_div = document.getElementById("pop_div");
				if (pop_div.style.display != "none") {
					defaultShowSlide();
				}
				pop_adv.addEventListener("tap", function() {					
					if (pop_div.style.display == "none") {
						pop_div.style.display = "";
						defaultShowSlide();
					} else {
						pop_div.style.display = "none";
					}
				});
				plus.push.setAutoNotification(false);
				var info = plus.push.getClientInfo();
				plus.storage.setItem("clientid", info.clientid);
				plus.storage.setItem("appid", info.appid);
				plus.storage.setItem("appkey", info.appkey);
				plus.storage.setItem("token", info.token);
				console.log(info.appkey);
				plus.push.addEventListener("click", function(msg) {
					// 判断是从本地创建还是离线推送的消息
					switch (msg.payload) {
						case "LocalMSG":
							outSet("点击本地创建消息启动：");
							break;
						default:
							outSet("点击离线推送消息启动：");
							break;
					}
					// 处理其它数据
					logoutPushMsg(msg);
				}, false);
				// 监听在线消息事件
				plus.push.addEventListener("receive", function(msg) {
					if (msg.aps) { // Apple APNS message
						//					mui.toast("接收到在线APNS消息：");
					} else {
						//					mui.toast("接收到在线透传消息：");
					}
					logoutPushMsg(msg);
				}, false);
				/**
				 * 日志输入推送消息内容
				 */
				function logoutPushMsg(msg) {
					if (msg.payload) {
						islogin = plus.storage.getItem('islogin');
						/*判空操作*/
						if (islogin == null) {
							plus.storage.setItem('islogin', 0);
						}
						if ((islogin != 1) || (islogin != "1")) {
						} else {
							 mui.openWindow({
								id: "qiangdan",
								url: "qiangdan.html",
								extras: {
									param: msg.payload
								}
							});
						}	
					} else {
						console.log("payload: undefined");
					}
					if (msg.aps) {
						console.log("aps: " + JSON.stringify(msg.aps));
					}
				}
			})
			/*增加标记点*/
		function addMarker(point) { // 创建图标对象   
			var myIcon = new BMap.Icon("img/car.png", new BMap.Size(20, 20));
			// 创建标注对象并添加到地图   
			var marker = new BMap.Marker(point, {
				icon: myIcon
			});
			map.addOverlay(marker);
			preMarker.push(marker);
		}
		//获取司机列表
		function get_coachlist_info() {
			coach_lonArr = new Array();
			coach_latArr = new Array();
			//初始化，清空数组元素
			coach_lonArr.splice(0, coach_lonArr.length);
			coach_latArr.splice(0, coach_latArr.length);
			var url = request_url + "get_coach_list";
			mui.getJSON(url, function(rsp) {
				//console.log(JSON.stringify(rsp));
				if (preMarker.length > 0) {
					for (var i = 0; i < preMarker.length; i++) {
						map.removeOverlay(preMarker[i]);
					}
					preMarker.length = 0;
				}
				for (var i = 0; i < rsp.Table.length; i++) {
					coach_lonArr[i] = rsp.Table[i].coach_lon;
					coach_latArr[i] = rsp.Table[i].coach_lat;
					addMarker(new BMap.Point(coach_lonArr[i], coach_latArr[i]));
				}
			});
			window.setTimeout("get_coachlist_info()", 2000);
		}
		/*初始化地图时时定位信息*/
		function geoInf(position) {
			var codns = position.coords; //获取地理坐标信息；
			var lat = codns.latitude; //获取到当前位置的纬度；			
			var longt = codns.longitude; //获取到当前位置的经度
			var url = "http://api.map.baidu.com/geocoder/v2/?ak=FC9c13967bf240823ed03d702d883e83&location=" + lat + "," + longt + "&output=json&pois=1"
			mui.getJSON(url, function(rsp) {
				if (rsp != null) {
					console.log(JSON.stringify(rsp));
					var addComp = rsp.result.addressComponent;
					var currentStreet = addComp.district + addComp.street;
					var currentPosition = rsp.result.sematic_description;
					console.log(currentPosition);
					var mPoint = new BMap.Point(longt, lat);
					if (currentPosition != "") {
						document.getElementById("map_result").innerHTML = "<lable style='color: darkgreen;font-weight: 900;'>我从</lable> " + currentStreet + "<br/>" + currentPosition + " <lable style='color: darkgreen;font-weight: 900;'>上车</lable>";
						plus.storage.setItem("start_postion", currentStreet + currentPosition + "&" + mPoint.lat + "&" + mPoint.lng);
					} else {
						document.getElementById("map_result").innerHTML = "<lable style='color: darkgreen;font-weight: 900;'>我从</lable> " + currentStreet + " <lable style='color: darkgreen;font-weight: 900;'>上车</lable>";
						plus.storage.setItem("start_postion", currentStreet + "&" + mPoint.lat + "&" + mPoint.lng);
					}
					map.centerAndZoom(mPoint, 15); // 初始化地图，设置中心点坐标和地图级别
//					document.getElementById("map_result").addEventListener("click", function() {
//						islogin = plus.storage.getItem('islogin');
//						/*判空操作*/
//						if (islogin == null) {
//							plus.storage.setItem('islogin', 0);
//						}
//						if ((islogin != 1) || (islogin != "1")) {
//							mui.openWindow({
//								id: "login",
//								url: "login/login.html"
//							});
//						} else {
//							plus.storage.setItem('date_type', "1");
//							mui.openWindow({
//								id: "yuyue",
//								url: "yuyue.html"
//							})
//						}
//					});
				}
			});
		}
		// 通过百度定位模块获取位置信息
		function getPosBaidu() {
			plus.geolocation.getCurrentPosition(geoInf, function(e) {
				console.log("info----" + e.message);
			}, {
				provider: 'baidu'
			});
		}
		/*增加首页默认滑动事件*/
		function defaultShowSlide() {
				
			var gallery = mui("#slider");
			gallery.slider({
				interval: 3000
			});
		};
		/*回到当前位置点击事件 */
		var back_current_position = document.getElementById("back_current_position");
		back_current_position.addEventListener("tap", function() {
			plus.geolocation.getCurrentPosition(geoInf, function(e) {
				console.log("info----" + e.message);
			}, {
				provider: 'baidu'
			});
		});
	</script>

</html>